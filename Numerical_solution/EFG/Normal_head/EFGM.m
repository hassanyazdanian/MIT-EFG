close all
clc
lthd =  size(nd,2);
nsorc=dat(1,3);% Number of sources
nmat=dat(1,4);% Number of materials
scale=dat(1,5);% Scale
jj=sqrt(-1);   %imaginary symbol


ncoil=16;
L=0.2;     % Length of coils (Z Direction) 20 cm
D=0;       % Width of coils (5.8) are negligible respect to their lengths
Turn=10;    % Turn in each coil

Acoil=(5*scale*30*scale);
magsorc=ds(:,2)./Acoil;
angsorc=pi/180*ds(:,3);

excit=zeros(ncoil,nmat);
mm=1;

for ic=1:ncoil
    for jc=1:2
        excit(ic,coil(ic,jc))=magsorc(mm)*cos(angsorc(mm))+jj*magsorc(mm)*sin(angsorc(mm));
        mm=mm+1;
    end
end



K=sparse(numnod,numnod);
B = sparse(numnod,1);
exper=0;                              %experiment counter

for j=1:size(gp,2)
    gg=gp(:,j);
    n=Base(j,1);
    K(Base(j,2:n+1),Base(j,2:n+1)) = K(Base(j,2:n+1),Base(j,2:n+1))+((gg(3)*(1/nu0)*gg(4)).*(Base(j,2*n+2:3*n+1)'*Base(j,2*n+2:3*n+1)+Base(j,3*n+2:4*n+1)'*Base(j,3*n+2:4*n+1))+(gg(3)*(1i*w*Sig(j))*gg(4)).*(Base(j,n+2:2*n+1)'*Base(j,n+2:2*n+1)));
end

GG = zeros(numnod,lthd);

for j=1:lthd
    GG(Base2(j,2:Base2(j,1)+1),j)=GG(Base2(j,2:Base2(j,1)+1),j)+Base2(j,Base2(j,1)+2:2*Base2(j,1)+1).';
end
k = ([K GG;GG.' zeros(lthd)]);

 for ic=1:ncoil
    A=sparse(numnod,1);
    Aq=sparse(numnod,1);
    B=sparse(numnod,1);
    f(:,1)=excit(ic,de(:,4));
    fp=f1_Element_nodes(de,dn,Nelem,gp,f);
    for j=1:size(gp,2)
        gg=gp(:,j);
        B(Base(j,2:Base(j,1)+1),1)=B(Base(j,2:Base(j,1)+1),1)+(gg(3)*gg(4))*Base(j,Base(j,1)+2:2*Base(j,1)+1).'*fp(j);
    end

    B = [B;zeros(lthd,1)];


    

    A=k\B;  %(photon density in FEM nodes)
    A=A(1:numnod);
    parfor j=1:length(xe)
     Aq(j,1) = Base1(j,Base1(j,1)+2:2*Base1(j,1)+1)*A(Base1(j,2:Base1(j,1)+1),1);
    end
    
    Aq=full(Aq);
    Aind(ic,:)=Aq.';%induction voltage vector for each excit
    for ir=ic+1:ncoil
        exper=exper+1;
        V_F1_NH(exper,1)=-jj*w*Turn*L*(mean([Aind(ic,(recivNode(ir,1))),Aind(ic,(recivNode(ir,2)))])-mean([Aind(ic,(recivNode(ir,3))),Aind(ic,(recivNode(ir,4)))]));%measuring voltages
        % warning: the sign must be minus!
        % it must be noted that the minuse sign in voltage calculation it is
        % for correction of receiving nodes direction. In fact receiving node 2
        % must be minus from receiving node 1.
    end
 end
V_F1_NH_FE=[-0.208595888204296 + 119.366573360759i;0.0140444492307712 + 34.6000256514184i;0.0751713122836921 + 14.2777505821242i;0.0882820047934734 + 6.86164037324394i;0.0896521050119554 + 3.70708218591270i;0.0917288641414170 + 2.27143426404882i;0.0958031379303893 + 1.63726805507575i;0.0972589448187699 + 1.45465782212606i;0.0935218244146256 + 1.63449551150349i;0.0856016936602093 + 2.27097200391816i;0.0767879225495841 + 3.70915252699541i;0.0677826660641635 + 6.87483645574626i;0.0471196972700976 + 14.3011079521140i;-0.0231588801320006 + 34.6674967341415i;-0.236161686787701 + 119.812519079343i;-0.294062723969812 + 119.819823435274i;-0.123980098450610 + 34.6483799075714i;-0.0304987249507766 + 14.3098767722261i;0.0190883497364227 + 6.87543973651512i;0.0508048885540203 + 3.71001342344830i;0.0748772364900961 + 2.27210690125804i;0.0928791236829762 + 1.63552490936061i;0.103525183413578 + 1.45291984500360i;0.108476009628619 + 1.63483765561345i;0.116253140744082 + 2.26902364300760i;0.133064741616106 + 3.70481925884201i;0.157264186678749 + 6.85502998544246i;0.169170314163268 + 14.2771010967013i;0.0824482958008817 + 34.6526287801243i;-0.281122435985835 + 119.719040351844i;-0.149594660603960 + 34.6356239693620i;-0.0576359170330526 + 14.3302304619807i;0.00599603227757607 + 6.88505045668483i;0.0524212699283593 + 3.71258578738096i;0.0862480784541905 + 2.27142960262706i;0.106145038032736 + 1.63462741428067i;0.113628987461419 + 1.45403824089540i;0.121765089189559 + 1.63490069260553i;0.139341264330110 + 2.26960133884013i;0.168578362155019 + 3.69826317337520i;0.200627717069395 + 6.84960240355967i;0.182152419954050 + 14.2826527711052i;-0.239540063084547 + 119.629635971472i;-0.140611003121562 + 34.6056627075173i;-0.0480563059743228 + 14.3334190243666i;0.0269318846174268 + 6.88061030768881i;0.0818029543359529 + 3.70885886903101i;0.111729704606178 + 2.26901125351639i;0.117849823064903 + 1.63517272591805i;0.119477531454240 + 1.45413678286713i;0.127808652103351 + 1.63649264274770i;0.146442456038292 + 2.26694107939016i;0.171033545120484 + 3.69749329033726i;0.169020841137080 + 6.85762421061547i;-0.232100458014633 + 119.603466011027i;-0.129530332973072 + 34.6351611411777i;-0.0156920309924855 + 14.3229195813369i;0.0750644911365585 + 6.87182205444138i;0.123530758788559 + 3.70326968075323i;0.129874625336499 + 2.26830153470567i;0.124054540924100 + 1.63457402035888i;0.121806358537962 + 1.45582553906582i;0.128344357788857 + 1.63502541131282i;0.141886766945786 + 2.26735725470571i;0.142231512852988 + 3.70457436535367i;-0.246685188656368 + 119.633039453273i;-0.101436159655032 + 34.6258079006181i;0.0496943158090626 + 14.3020446406386i;0.135368196984668 + 6.85798967801540i;0.148458063583214 + 3.69969141264862i;0.136696544588763 + 2.26642057972786i;0.124405061528204 + 1.63629160498749i;0.119783209467899 + 1.45440135390794i;0.123141431714961 + 1.63453381743775i;0.121886883223741 + 2.27009348999813i;-0.262029729808055 + 119.687370087791i;-0.0351297530163186 + 34.6929588723996i;0.123657523683485 + 14.2985166845358i;0.161309775705349 + 6.85811484800554i;0.150630640401543 + 3.69893045586551i;0.131500316820724 + 2.26942500273026i;0.118141469833709 + 1.63523699473729i;0.113625571455676 + 1.45395728797711i;0.110668490201374 + 1.63663721756493i;-0.233608081915170 + 119.854063495515i;0.0294448190290916 + 34.6728200174459i;0.132049467945620 + 14.3065142436994i;0.144258347543943 + 6.86594425966625i;0.129422171525027 + 3.70929406649420i;0.113935699204146 + 2.27229597705629i;0.106202250195775 + 1.63674201479714i;0.104042579370328 + 1.45658604594132i;-0.224084141724393 + 119.245897691011i;-0.0128678143428011 + 34.6366299426463i;0.0706075425022240 + 14.2990262371045i;0.0887396233471554 + 6.86933859268683i;0.0879080707471925 + 3.70712413498790i;0.0874414558038960 + 2.26928279433733i;0.0927141517757958 + 1.63525218592365i;-0.257696584071281 + 119.557650862893i;-0.0816632862758321 + 34.6793856015185i;0.000132477732189019 + 14.3197781334519i;0.0339483001271239 + 6.87705998789184i;0.0528977441958338 + 3.70725179150236i;0.0732032853985217 + 2.26871003721924i;-0.244981056611129 + 119.587045241822i;-0.120120958467377 + 34.6331018947392i;-0.0443303970046685 + 14.3380230698149i;0.00292784714875114 + 6.88388359458518i;0.0456030695568425 + 3.70937026755659i;-0.232124429528580 + 119.372058401118i;-0.142293944137537 + 34.6505340944733i;-0.0664984533161453 + 14.3429806532847i;0.00773455008888064 + 6.87963492437041i;-0.237166542474996 + 118.875551556787i;-0.157921503026251 + 34.6287188401887i;-0.0462076342788486 + 14.3176138463400i;-0.272707350115946 + 119.093968353585i;-0.135889001881427 + 34.6273019222557i;-0.288117432395667 + 119.403408735045i];


% Up=0;
% Down=0;
% 
% for i=1:size(V_F1_HLD_real,1)
%     
%     Up=Up+(abs(real(V_F1_NH(i,1)))-abs(real(V_F1_HLD_real(i,1))))^2;
%     Down=Down+(real(V_F1_HLD_real(i,1)))^2;
%     
% end
% norm_error_real_egf=100*sqrt(Up/Down)
% 
% Up=0;
% Down=0;
% 
% for i=1:size(V_F1_HLD_real,1)
%     
%     Up=Up+(abs(real(V_F1_NH_FE(i,1)))-abs(real(V_F1_HLD_real(i,1))))^2;
%     Down=Down+(real(V_F1_HLD_real(i,1)))^2;
%     
% end
% norm_error_real_fe=100*sqrt(Up/Down)
% 
% Up=0;
% Down=0;
% 
% for i=1:size(V_F1_HLD_real,1)
%     
%     Up=Up+(abs(imag(V_F1_NH(i,1)))-abs(imag(V_F1_HLD_real(i,1))))^2;
%     Down=Down+(imag(V_F1_HLD_real(i,1)))^2;
%     
% end
% norm_error_imag_efg=100*sqrt(Up/Down)
% 
% Up=0;
% Down=0;
% 
% for i=1:size(V_F1_HLD_real,1)
%     
%     Up=Up+(abs(imag(V_F1_NH_FE(i,1)))-abs(imag(V_F1_HLD_real(i,1))))^2;
%     Down=Down+(imag(V_F1_HLD_real(i,1)))^2;
%     
% end
% norm_error_imag_fe=100*sqrt(Up/Down)



plot(real(V_F1_NH),'r')
hold on
plot(real(V_F1_NH_FE),'b')

figure

plot(imag(V_F1_NH),'r')
hold on
plot(imag(V_F1_NH_FE),'b')
 
% figure
% pdeplot(dn',[],de','xydata',real(Aindfe(2,:)))
% figure
% pdeplot(dn',[],de','xydata',real(Aindefg(2,:)))
% figure
% pdeplot(dn',[],de','xydata',imag(Aindfe(2,:)))
% figure
% pdeplot(dn',[],de','xydata',imag(Aindefg(2,:)))




% k=zeros(size(gp,2),M,M);
% 
% parfor i=1:size(gp,2)
%     for m=1:M
%         for n=1:M
%             
%             k(i,m,n)=(weight(i)*(1/mu)*jac(i)).*(dphix(i,m).*dphix(i,n)+dphiy(i,m).*dphiy(i,n))+(weight(i).*(1i*w*Sig(i))*jac(i)).*(phi(i,m).*phi(i,n));%
% 
%         end
%         
%     end
% end
% 
% 
% 
% for i=1:size(gp,2)
%     for m=1:L(i)
%         for n=1:L(i)
%             if (v(i,m)~=0) &&(v(i,n)~=0)
%                 
%                 K(v(i,m),v(i,n)) = K(v(i,m),v(i,n))+k(i,m,n);
%             end
%         end
%     end
% end


% figure;
% hold on
% coun=0;
% for i1=1:ncoil
%     for j=1:4
%         coun=coun+1;
% %         x_recivNode(i1,j)=dn(recivNode(i1,j),1);
% %         y_recivNode(i1,j)=dn(recivNode(i1,j),2);
% %         n_recivNode(1,coun)=dn(recivNode(i1,j),1);
% %         n_recivNode(2,coun)=dn(recivNode(i1,j),2);
%         plot(xe(1,recivNode(i1,j)),xe(2,recivNode(i1,j)),'*r')
%     end
% end

